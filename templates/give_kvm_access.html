{% load crispy_forms_filters %}
{% load crispy_forms_tags %}
<div class="container">
    <h1 id="title">Give KVM Access</h1>
    <form id="create-user-form" method="POST" action="{% url 'kvmwebapp:create_user' %}">
        {% csrf_token %}
        <div class="form-group row">
            <div class="col-sm-9 offset-sm-3">
                <input type="text" class="form-control" id="id_username" name="username" placeholder="Username" required>
            </div>
        </div>
        <div class="form-group row">
            <div class="col-sm-9 offset-sm-3">
                <input type="text" class="form-control" id="email" name="email" placeholder="Email">
            </div>
        </div>

        <input type="hidden" name="row" value="{{ row }}">
        <input type="hidden" name="rack" value="{{ rack }}">
        <input type="hidden" name="rack_port" value="{{ rack_port }}">
        <input type="hidden" name="server_room" value="{{ server_room }}">
        <div class="form-group row">
            <label for="id_start_time" class="col-sm-3 col-form-label"></label>
            <div class="col-sm-9">
                <input type="hidden" name="start_time" class="form-control" id="id_start_time" value="{{ current_time }}" required>
            </div>
        </div>

        <div class="form-group row">
            <div class="col-sm-9 offset-sm-3">
                <input id="create-button" type="submit" value="Create" class="btn btn-primary">
            </div>
        </div>
        <input type="hidden" name="username" id="id_hidden_username">
    </form>
    <div class="message"></div>
    <br>
    <button style="display: none" id="home" onclick="window.history.back()">OK</button>
</div>

<script>
function formatDate(date) {
    var year = date.getFullYear();
    var month = (date.getMonth() + 1).toString().padStart(2, '0');
    var day = date.getDate().toString().padStart(2, '0');
    var hours = date.getHours().toString().padStart(2, '0');
    var minutes = date.getMinutes().toString().padStart(2, '0');
    return year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;
}


document.getElementById('create-user-form').addEventListener('submit', function(event) {
    event.preventDefault();
    var form = event.target;

    document.getElementById('id_hidden_username').value = document.getElementById('id_username').value;
    document.getElementById('id_username').hidden = true;
    document.getElementById('create-button').hidden = true;
    document.getElementById('email').hidden = true;
    document.getElementById("home").style.display = "block";
    document.getElementById('title').innerHTML = 'User Created';
    document.getElementById('title').style="background-color: #00ff00";

    var now = new Date();
    document.getElementById('id_start_time').value = formatDate(now);
    document.getElementById('id_start_time').hidden = true;


    // Add the formatted stop_time to FormData
    var formData = new FormData(form);


    console.log('Submitting form with data:', formData);

    fetch(form.action, {
        method: 'POST',
        body: formData
    }).then(function(response) {
        return response.json();  // Always parse the JSON response
    }).then(function(data) {
        if (data.success) {
            document.getElementById('title').innerHTML = 'Access given';
            document.getElementById('title').style="background-color: #00ff00";
            console.log('Form submission successful');
            var message = 'Username: ' + data.username + '<br>Password: ' + data.password + '<br>Email: ' + data.email + '<br>Issued by: ' + data.issued_by + '<br><br>Use your username and password to log in to the KVM web app.';
        } else {
            document.getElementById('title').innerHTML = 'Error';
            document.getElementById('title').style="background-color: red";
            console.log('Form submission failed with errors:', data.errors);
            var message = '';
            for (var field in data.errors) {
                message += data.errors[field].join(' ') + '<br>';
            }
        }
        document.querySelector('.message').innerHTML = message;
    }).catch(function(error) {
        console.error('Form submission error:', error);
    });
});


</script>

